name: Build DeskNote

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# Write permission required for gh release create
permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
      # ── Checkout & toolchain setup ──────────────────────────────────────────
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # ── Install deps ────────────────────────────────────────────────────────
      # npm ci uses package-lock.json for reproducible installs
      - name: Install frontend dependencies
        run: npm ci

      # ── Build ───────────────────────────────────────────────────────────────
      - name: Build Tauri app
        run: npm run tauri build

      # ── Collect artifacts ───────────────────────────────────────────────────
      - name: Collect artifacts
        shell: bash
        run: |
          mkdir -p dist-artifacts

          # Copy NSIS installer (.exe) and MSI if present
          find src-tauri/target/release/bundle -type f \( -name "*.exe" -o -name "*.msi" \) \
            | while IFS= read -r f; do
                cp "$f" dist-artifacts/
                echo "  Collected: $f"
              done

          # Copy portable exe with a clear name
          portable="src-tauri/target/release/desknote.exe"
          if [ -f "$portable" ]; then
            cp "$portable" "dist-artifacts/DeskNote-portable.exe"
            echo "  Collected portable: $portable"
          fi

          echo ""
          echo "=== dist-artifacts/ ==="
          ls -lh dist-artifacts/ || echo "(empty)"

      # ── Create GitHub Release (tag pushes only) ─────────────────────────────
      # Uses gh CLI (pre-installed on all GitHub-hosted runners)
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tag="${GITHUB_REF#refs/tags/}"

          # Mark pre-release for tags with a hyphen (e.g. v0.2.0-beta.1)
          prerelease_flag=""
          [[ "$tag" == *"-"* ]] && prerelease_flag="--prerelease"

          # Build file list (handle empty dist-artifacts gracefully)
          files=(dist-artifacts/*)
          if [ ! -e "${files[0]}" ]; then
            echo "WARNING: No artifacts found"
            files=()
          fi

          gh release create "$tag" "${files[@]}" \
            --title "DeskNote $tag" \
            --notes "## DeskNote $tag

**Windows 安装说明**:
| 文件 | 说明 |
|------|------|
| \`*-setup.exe\` | NSIS 安装包（推荐） |
| \`*.msi\` | MSI 安装包 |
| \`DeskNote-portable.exe\` | 便携版，无需安装直接运行 |

**系统要求**: Windows 10/11，WebView2 Runtime（Windows 11 已内置）" \
            $prerelease_flag

      # ── Upload artifacts to Actions (fallback / manual dispatch) ────────────
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: DeskNote-Windows-${{ github.ref_name }}
          path: dist-artifacts/
          retention-days: 30
          if-no-files-found: warn
